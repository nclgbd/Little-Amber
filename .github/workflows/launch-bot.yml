# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions

name: Deploying Amber

on:
  push:
    branches: [ setup-config ]
  pull_request:
    types: [ closed ]
    branches: [ master ]

jobs:
  launch-application:
    runs-on: ubuntu-latest

    steps:
    - name: install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.EC2TUTKEY }}
        name: id_rsa # optional
        known_hosts: ssh-keyscan -H github.com > ~/.ssh/known_hosts
    - uses: actions/checkout@v2
    - name: setting up python 3.6
      uses: actions/setup-python@v2
      with:
        python-version: 3.6
    - name: copying ssh key
      run: |
        ssh_dir=config/.ssh
        mkdir -p ${ssh_dir}
        aws_key=config/.ssh/ec2tutkey.pem
        touch ${aws_key}
        echo '${{ secrets.EC2TUTKEY }}' > ${aws_key}   
        
        sudo chmod 644 ${aws_key}
        git config pull.ff only
        git pull

        ls -la ${ssh_dir}
    - name: pull application and deploy
      run: |
        pwd
        ls -la config/.ssh/
        sudo cat ~/.ssh/known_hosts
        ssh -i "~/.ssh/ec2tutkey.pem" ec2-user@ec2-34-216-70-159.us-west-2.compute.amazonaws.com "
        cd Little-Amber/\n
        forever stopall\n
        git commit -am "${{ secrets.GITHUB_REF }}"\n
        passphrase = ${{ secrets.SSH_PASSPHRASE }}\n
        forever start -c python3 scripts/main.py\n
        "

          
    
